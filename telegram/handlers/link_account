/**
 * Telegram Handler â€“ Link WhatsApp Account (Pairing Code)
 * - ÙŠØ·Ù„Ø¨ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
 * - ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø±Ø¨Ø·
 * - ÙŠØ±Ø³Ù„ Pairing Code Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø¥Ù„Ù‰ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
 */

const { createAccount } = require('../../whatsapp/accounts');
const logger = require('../../utils/logger');

// Ø­Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…
const waitingForPhone = new Map();

/**
 * Ø¨Ø¯Ø¡ Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨ ÙˆØ§ØªØ³Ø§Ø¨
 */
async function startLinkAccount(bot, chatId) {
  waitingForPhone.set(chatId, true);

  await bot.sendMessage(
    chatId,
    'ğŸ“± *Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨ ÙˆØ§ØªØ³Ø§Ø¨*\n\n' +
      'Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø¯ÙˆÙ„ÙŠ Ø¨Ø¯ÙˆÙ† Ø¹Ù„Ø§Ù…Ø© +\n\n' +
      'Ù…Ø«Ø§Ù„:\n' +
      '`9677XXXXXXXX`\n\n' +
      'âš ï¸ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø±Ù‚Ù… Ù…ÙØ¹Ù„ Ø¹Ù„ÙŠÙ‡ ÙˆØ§ØªØ³Ø§Ø¨',
    { parse_mode: 'Markdown' }
  );
}

/**
 * Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ø±Ø¨Ø·
 */
async function handlePhoneNumber(bot, msg) {
  const chatId = msg.chat.id;
  const text = msg.text ? msg.text.trim() : '';

  if (!waitingForPhone.has(chatId)) return;
  if (text.startsWith('/')) return;

  const phone = text.replace(/\s+/g, '');

  if (!/^\d{8,15}$/.test(phone)) {
    await bot.sendMessage(
      chatId,
      'âŒ Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­.\n\n' +
        'Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø¯ÙˆÙ„ÙŠ Ø¨Ø¯ÙˆÙ† +\n' +
        'Ù…Ø«Ø§Ù„:\n' +
        '`9677XXXXXXXX`',
      { parse_mode: 'Markdown' }
    );
    return;
  }

  waitingForPhone.delete(chatId);

  // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
  const account = createAccount();

  await bot.sendMessage(
    chatId,
    'ğŸ”— ÙŠØªÙ… Ø§Ù„Ø¢Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø±Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨...\n\n' +
      'ğŸ“² Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ *Ø±Ù…Ø² Ø§Ù‚ØªØ±Ø§Ù†* Ø®Ù„Ø§Ù„ Ù„Ø­Ø¸Ø§Øª\n\n' +
      'Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨:\n' +
      'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â†’ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© â†’ Ø±Ø¨Ø· Ø¬Ù‡Ø§Ø² â†’ Ø§Ù„Ø±Ø¨Ø· Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ',
    { parse_mode: 'Markdown' }
  );

  try {
    // Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø¨Ø·
    await account.connectWithPairing(phone);

    // Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø­Ø¸Ø© Ø­ØªÙ‰ ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ù…Ø²
    let tries = 0;
    while (!account.pairingCode && tries < 20) {
      await new Promise(r => setTimeout(r, 300));
      tries++;
    }

    if (!account.pairingCode) {
      throw new Error('Pairing Code Ù„Ù… ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯Ù‡');
    }

    await bot.sendMessage(
      chatId,
      'ğŸ” *Ø±Ù…Ø² Ø§Ù„Ø§Ù‚ØªØ±Ø§Ù† (Pairing Code)*\n\n' +
        `\`${account.pairingCode}\`\n\n` +
        'ğŸ“± Ø§ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ ÙˆØ£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²:\n' +
        'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â†’ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© â†’ Ø±Ø¨Ø· Ø¬Ù‡Ø§Ø² â†’ Ø§Ù„Ø±Ø¨Ø· Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ\n\n' +
        'âš ï¸ Ù„Ø§ ØªØ´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø² Ù…Ø¹ Ø£ÙŠ Ø´Ø®Øµ',
      { parse_mode: 'Markdown' }
    );

    logger.info(
      `ğŸ“± Pairing Code Ø£ÙØ±Ø³Ù„ Ø¥Ù„Ù‰ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… Ù„Ù„Ø­Ø³Ø§Ø¨ ${account.id}`
    );
  } catch (err) {
    logger.error('âŒ ÙØ´Ù„ Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨ ÙˆØ§ØªØ³Ø§Ø¨', err);

    await bot.sendMessage(
      chatId,
      'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±Ø¨Ø· Ø§Ù„Ø­Ø³Ø§Ø¨.\n\n' +
        'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù…Ù† Ø²Ø± Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨ ÙˆØ§ØªØ³Ø§Ø¨.'
    );
  }
}

module.exports = {
  startLinkAccount,
  handlePhoneNumber
};
